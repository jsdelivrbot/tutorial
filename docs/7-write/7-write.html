<h2 id="lab-7-ui-writing-to-an-api-example-firebase-">Lab 7: UI Writing to an API (Example: Firebase)</h2>
<ol>
<li><p>In a browser, return to the linkblog list at <a href='http://localhost:8091/admin/linkblog/' target='_blank'>http://localhost:8091/admin/linkblog/</a>, and click the &#39;Add Item&#39; button to see <a href='http://localhost:8091/admin/linkblog/detail.html' target='_blank'>http://localhost:8091/admin/linkblog/detail.html</a>. Note that the date field is pre-populated with today&#39;s date. In VS Code, inspect <code>/topseed-webroot/admin/linkblog/detail.pug</code>. This file defines the composition of the linkblog &#39;Add Item&#39; screen. In the HTML part of this file, the data entry form represented by the pug statement <code>&#39;form#form1&#39;</code> (<code>&#39;&lt;form id=&quot;form1&quot;&gt;&#39;</code>). Note that it has <code>&#39;onsubmit=&#39;return false&#39;</code>, because we do not want the browser default behavior of posting to a form action URL.</p>
</li>
<li><p>Similar to the  list page, in <code>&#39;script.&#39;</code> we load <code>/admin/linkblog/LinkblogBusiness.js</code>, and then call the <code>&#39;UIinit&#39;</code> function in the page. <code>&#39;UIinit</code>&#39; triggers the <code>&#39;detail()&#39;</code> function of <code>LinkblogBusiness</code>, which loads today&#39;s date into the form. <code>&#39;UIinit&#39;</code> also specifies to call the <code>LinkblogBusiness</code> <code>&#39;save()&#39;</code> function when the form is submitted (when the &#39;Save&#39; button is clicked) instead of the default behavior, and pass any authentication cookie along. Since we are working with similar data as in the list page, and the two pages belong together, we have chosen to augment <code>LinkblogBusiness.js</code> with the <code>&#39;detail()&#39;</code> and <code>&#39;save()</code>&#39; functions rather than creating separate <code>LinkblogListBusiness</code> and <code>LinkblogAddBusiness</code>. For a different module we would create a separate <code>XxxBusinness</code>.</p>
</li>
<li><p>Reopen <code>/topseed-webroot/admin/linkblog/LinkblogBusiness.js</code> and locate the <code>&#39;detail: function(&#39;</code>. We use <a href='https://momentjs.com/' target='_blank'>https://momentjs.com/</a> for date handling and jquery.jsForm from <a href='https://github.com/corinis/jsForm' target='_blank'>https://github.com/corinis/jsForm</a> to populate the form with the date. The necessary libraries are loaded in <code>/_js/admin.js</code>. You see the result of the call to <code>&#39;detail()&#39;</code> when rendering of the page has completed.</p>
</li>
<li><p>Fill some data in the form and click &#39;Save&#39;. You should see an alert that saving is not enabled: we are not yet configured to use a database that allows saving. In <code>LinkblogBusiness.js</code>, locate the <code>&#39;save: function(&#39;</code>. Once we enable <code>&#39;update&#39;</code> in the <code>urlSpec</code>, processing will continue. We obtain the <code>&#39;formData&#39;</code> with <code>&#39;jquery.jsForm(&#39;get&#39;)&#39;</code>, and pass it to the <code>&#39;linkblogDao.update&#39;</code> function. Once this has returned successfully (<code>&#39;promise.then(&#39;</code>), we redirect to the list page. <code>BLX</code>/<code>sb</code>has base functionality using turbo for the new page load.</p>
</li>
<li><p>Reopen <code>BDS</code> and look for <code>&#39;update: function(&#39;</code>. It calls a shared static <code>_post</code> function which uses <code>fetch_</code> to call the <code>urlSpec</code> update URL. </p>
</li>
<li><p>It is time to connect <code>LinkblogDao</code>/<code>BDS</code> to a live database. Go to the top of <code>LinkblogBusiness.js</code>, comment out the first <code>urlSpec</code> and comment in the <code>urlSpec</code> that goes to localhost:8081, does not use <code>dummy.json</code> and also has an <code>update</code> route, unlike the first <code>urlSpec</code>. We included a basic API server implementation in the topseed project at <code>/topseed/bsrv</code> that we will run at localhost:8081. The API server in turn will call a Google Firebase service that you will configure in the next step. Why do we not call the Firebase API directly from the browser? We do not want the browser to hold the authentication credentials for the database connection (more about user authentication in the next tutorial).</p>
</li>
<li><p>Log into your Gmail/Google account at https://mail.google.com (Create one if you don&#39;t have one). Navigate to <a href='https://console.firebase.google.com/' target='_blank'>https://console.firebase.google.com</a>, click &#39;Add Project&#39;, enter &#39;mydb1&#39; as Project name when prompted and click &#39;Create Project&#39;.
Click the &#39;gear&#39; icon on the left menu (enlarge browser window if necessary to see it) to access Project Settings and click the &#39;Service Accounts&#39; tab. Copy the &#39;databaseURL&#39; value from the Node.js Admin SDK configuration snippet and paste it into the  <code>/topseed/bsrv/config/ApiConfig.js</code> DB_URL return value. The line in <code>ApiConfig.js</code> should look something like <code>&#39;get DB_URL() { return &#39;https://mydb1-7b77e.firebaseio.com&#39; }&#39;</code> On the Google Project Settings Service Accounts tab, click &#39;Generate New Private Key&#39; and &#39;Generate Key&#39;. From the download prompt, save the file into the <code>/topseed/bsrv/scode/route/ds/</code> folder. Open <code>BaseFB.js</code>, and replace <code>&#39;serviceKey.json&#39;</code> with the filename. The line should look something like <code>&#39;const &#39;serviceAccount = require(&quot;./mydb1-7b77e-firebase-adminsdk-8swi6-f46e592e60.json&quot;)&#39;</code>. Verify that the path starts with <code>&#39;./&#39;</code>.</p>
</li>
<li><p>You are ready to start the API server that uses this configuration. In VS Code, open another Terminal Shell <code>(Ctrl+Shift+`)</code>, type <code>&#39;cd bsrv [Enter]&#39;</code>, do the <code>&#39;npm install [Enter]&#39;</code> and then <code>&#39;node index [Enter]&#39;</code>.
You should see console output &#39;API server listening at http://localhost:8081&#39;. On the VS Code terminal tab, use the dropdown go to the tab for topseed-srv, and start topseed-srv if not already running. You should see console output &#39;Web server listening at http://localhost:8091&#39; (and 8092).</p>
</li>
<li><p>In a browser, go to or refresh the linkblog list at <a href='http://localhost:8091/admin/linkblog/' target='_blank'>http://localhost:8091/admin/linkblog/</a>. The list should now say &#39;No data available in table&#39;, because <code>LinkblogBusiness</code> <code>&#39;urlSpec&#39;</code> points to the newly configured API server that has an &#39;empty&#39; database. Click &#39;Add Item&#39;, enter some values and click &#39;Save&#39;. Your item should appear in the list. Back in the Google Firebase Console at <a href='https://console.firebase.google.com/' target='_blank'>https://console.firebase.google.com/</a>, for the project &#39;mydb1&#39;, navigate to &#39;Database&#39; from the menu tree on the left. You should be able to drill down to see the newly created entry in a table named &#39;links11&#39;. If you like, return to the linkblog list at <a href='http://localhost:8091/admin/linkblog/' target='_blank'>http://localhost:8091/admin/linkblog/</a> in the browser and add a few more items with &#39;Add Item&#39;.</p>
</li>
<li><p>Optional: Learn how the API server at <code>/bsrv</code> works. Inspect <code>/bsrv/index.js</code>. The line beginning with <code>&#39;server.use(&#39;/linkblog&#39;&#39;</code> specifies that any requests to localhost:8081/linkblog are handled
by <code>/scode/route/LinkblogService.js</code>. Inspect this file. The function beginning with <code>&#39;router.post(&#39;/&#39;&#39;</code> specifies in the line <code>&#39;const _promise = linkblog.update(row)&#39;</code> that a post request will call the update function in <code>/ds/Linkblog.js</code>. Inspect this file. <code>Linkblog.js</code> specifies the table name as &#39;links11&#39;, but also extends <code>BaseFB</code>. (Since <code>Linkblog.js</code> runs in the Node.js server and not in the browser, we can use <code>&#39;extends&#39;</code> instead of <code>&#39;.extends([&#39;</code>). <code>BaseFB</code> has the common functionality to create a Firebase connection, query and update the database. For this, it uses the &#39;firebase-admin&#39; package imported as a dependency in <code>/bsrv/package.json</code>. To add a row, the <code>BaseFB.js</code> function <code>&#39;update(row)&#39;</code> was used. Similarly, a &#39;get&#39; request to localhost:8081/linkblog uses <code>BaseFB.js</code> <code>&#39;selectList()&#39;</code> to obtain the list of linkblog items. </p>
</li>
<li><p>Perspective: For a complete Create-Read-Update-Delete (CRUD) implementation, we would add single-row query, update and delete capablity. To edit existing items, we would navigate to <code>&#39;/detail.html?id=x&#39;</code> and, in <code>LinkblogBusiness</code> <code>&#39;detail()&#39;</code>, use the &#39;id&#39; URL parameter to obtain the existing data querying by a primary key column or unique index on the database. If you were to use a database service provider other than Google Firebase, you would create an implementation of <code>BaseFB.js</code> using the alternative provider&#39;s API, following the provider&#39;s examples for Node.js. </p>
</li>
</ol>
